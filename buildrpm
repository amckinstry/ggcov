#!/bin/sh

FORCE=no

usage ()
{
    echo "Usage: $0 [--force]"
    exit 1
}

while [ $# -gt 0 ]; do
    case "$1" in
    --force|-f) FORCE=yes ;;
    *) usage ;;
    esac
    shift
done

set `sed -n -e 's|^AM_INIT_AUTOMAKE(\([^,]\+\),\([^)]\+\))|\1 \2|p' < configure.in`
PACKAGE=$1
VERSION=$2

SPECFILE=${PACKAGE}.spec
TARBALL=${PACKAGE}-${VERSION}.tar.gz
RPMDIR=rpm.d

if [ -x /usr/bin/rpmbuild ] ; then
    RPMBUILD=rpmbuild
else
    RPMBUILD=rpm
fi

# Calculate a string which identifies the Linux distro
DISTRO=
if [ -f /etc/redhat-release ]; then
    DISTRO=rh$(sed -e 's|.*release[ \t]\+\([^ \t]\+\).*|\1|g' < /etc/redhat-release)
fi

#echo PACKAGE=$PACKAGE
#echo VERSION=$VERSION
#echo TARBALL=$TARBALL
#echo RPMDIR=$RPMDIR
#echo DISTRO=$DISTRO
#echo RPMBUILD=$RPMBUILD
#echo FORCE=$FORCE
#exit 1

set -x

if [ $FORCE = yes ]; then
    # Force complete rebuild
    /bin/rm -rf config.status config.cache autom4te.cache
    /bin/rm -f $SPECFILE $TARBALL
fi

if [ ! -f $SPECFILE ]; then
    autoconf
    autoheader
    automake -a
    ./configure
    if [ ! -f $SPECFILE ]; then
    	echo "Can't build $SPECFILE, giving up"
	exit 1
    fi
fi

if [ ! -f $TARBALL ]; then
    make dist
    if [ ! -f $TARBALL ]; then
    	echo "Can't build $TARBALL, giving up"
	exit 1
    fi
fi

/bin/rm -rf $RPMDIR
mkdir -p $RPMDIR
(cd $RPMDIR ; mkdir -p BUILD RPMS/i386 RPMS/`uname -m` SPECS SRPMS )


$RPMBUILD -bb \
    --define "_topdir $PWD/$RPMDIR" \
    --define "_sourcedir $PWD" \
    --verbose \
    $SPECFILE

for f in $(find $RPMDIR/RPMS -type f -name \*.rpm) ; do
    f2=$(echo $(basename $f) | sed -e 's|^\([a-z-]\+-\)|\1'${DISTRO}${DISTRO:+-}'|')
    echo "Renaming $(basename $f) -> $f2"
    mv $f $f2
done

